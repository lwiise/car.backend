<!-- =====================  USER DASHBOARD (FINAL SYNCED, FIXED MODAL)  ===================== -->
<!-- Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@500;600;700&family=Montserrat:wght@400;500;600&display=swap" rel="stylesheet" />

<!-- Supabase -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // ---- Supabase client ----
  const SUPABASE_URL  = "https://zrlfkdxpqkhfusjktrey.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybGZrZHhwcWtoZnVzamt0cmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDc1MzYsImV4cCI6MjA3NTQyMzUzNn0.FG3eMKO7KRJ_GM4XXo5DEIDlWU7j9tjMJRJwpotNd6Y";
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // Netlify base + CORS-wrapped endpoints (auto-detect current site)
  const DEFAULT_SITE = "https://carbackendd.netlify.app";
  const SITE_ORIGIN =
    (typeof location !== "undefined" && location.origin && location.origin !== "null")
      ? location.origin
      : DEFAULT_SITE;
  const NETLIFY_BASE     = `${SITE_ORIGIN}/.netlify/functions`;
  const RESULTS_LIST_URL = `${NETLIFY_BASE}/resultsListCORS`;
  const CAR_IMAGE_URL    = `${NETLIFY_BASE}/carImageCORS`;
  const ASSET_BASE       = SITE_ORIGIN;
</script>

<style>
  :root{
    --bg-dark:#060a0e;
    --bg-darker:#030608;
    --ink:rgba(255,255,255,.94);
    --muted:rgba(255,255,255,.68);
    --outline:rgba(255,255,255,.1);
    --surface:rgba(142,165,182,.05);
    --overlay-light:rgba(4,8,12,.3);
    --overlay:rgba(4,8,12,.5);
    --overlay-dark:rgba(4,8,12,.6);
    --accent:142,165,182;
  }
  html,body{
    background:
      radial-gradient(1200px 800px at 15% -10%, rgba(var(--accent),0.12), transparent 60%),
      linear-gradient(180deg,var(--bg-dark),var(--bg-darker));
    color:var(--ink);
    font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    margin:0
  }
  html.modal-open,body.modal-open{overflow:hidden}

  .wrap{max-width:1200px;margin:36px auto 80px;padding:0 18px}
  .hero{display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap;margin-bottom:18px}
  .brand{display:flex;align-items:center;gap:14px}
  .badge-luxe{
    width:36px;height:36px;border-radius:50%;
    background:
      radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(var(--accent),0.25) 45%, rgba(4,8,12,.6) 78%),
      linear-gradient(135deg, rgba(var(--accent),0.45), rgba(var(--accent),0.12));
    border:1px solid var(--outline);
    box-shadow:0 8px 22px var(--overlay)
  }
  .ttl{
    margin:0;
    font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-weight:700;letter-spacing:.3px;
    font-size:40px;line-height:1.1
  }
  .sub{margin:6px 0 0;color:var(--muted);font-size:14px}
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    appearance:none;border:1px solid var(--outline);cursor:pointer;
    border-radius:14px;padding:10px 14px;
    font-weight:700;letter-spacing:.02em;
    transition:transform .06s,box-shadow .25s,background .25s,opacity .2s;
    font-size:1em;text-decoration:none;
    background:rgba(255,255,255,.06);color:var(--ink)
  }
  .btn-ghost{background:transparent;border:1px solid var(--outline)}
  .btn-ghost:hover{background:rgba(255,255,255,.08)}
  .btn-primary{
    background:linear-gradient(135deg, rgba(var(--accent),0.45), rgba(var(--accent),0.15));
    color:var(--ink);
    border:1px solid rgba(var(--accent),0.45);
    box-shadow:0 12px 36px var(--overlay)
  }
  .btn-primary:hover{box-shadow:0 16px 44px var(--overlay-dark)}
  .btn:disabled{opacity:.5;cursor:not-allowed}

  .panel{
    padding:16px;border-radius:16px;
    background:linear-gradient(180deg, rgba(var(--accent),0.12), var(--surface));
    border:1px solid var(--outline);
    box-shadow:0 24px 60px var(--overlay),inset 0 1px 0 rgba(255,255,255,.06);
    margin-bottom:16px
  }
  .section-ttl{
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;margin:22px 0 10px
  }
  .section-ttl h2{
    margin:0;
    font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-weight:700;
    font-size:28px
  }
  .grid{
    display:grid;gap:18px;
    grid-template-columns:repeat(3,minmax(0,1fr))
  }
  @media (max-width:1024px){.grid{grid-template-columns:repeat(2,minmax(0,1fr))}}
  @media (max-width:640px){.grid{grid-template-columns:1fr}}

  .card{
    position:relative;overflow:hidden;border-radius:18px;
    background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), var(--surface);
    border:1px solid var(--outline);
    box-shadow:0 22px 60px var(--overlay),inset 0 1px 0 rgba(255,255,255,.08)
  }
  .card:before{z-index:0}
  .card > *{position:relative;z-index:1}
  .card:before{
    content:"";position:absolute;inset:auto -40% 60% -40%;
    height:140%;
    background:radial-gradient(600px 300px at 50% 0%,rgba(var(--accent),0.22),transparent 60%);
    filter:blur(20px);pointer-events:none
  }
  .badge{
    position:absolute;top:12px;left:12px;z-index:2;
    padding:6px 10px;border-radius:999px;
    font-size:12px;font-weight:700;color:var(--bg-darker);
    background:linear-gradient(135deg, rgba(var(--accent),0.6), rgba(var(--accent),0.2));
    border:1px solid rgba(var(--accent),0.45);
    box-shadow:0 10px 26px var(--overlay)
  }
  .card-img{
    width:100%;height:190px;object-fit:cover;
    display:block;background:var(--bg-darker);opacity:.95
  }
  .card-body{padding:16px}
  .card h3{
    margin:0 0 6px;
    font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    font-size:24px;font-weight:700;color:#fff
  }
  .card p{margin:0;color:rgba(255,255,255,.72);font-size:14px}

  .timeline{position:relative;padding-left:22px}
  .timeline:before{
    content:"";position:absolute;left:8px;top:0;bottom:0;width:2px;
    background:linear-gradient(180deg,rgba(var(--accent),0.45),transparent)
  }
  .t-item{position:relative;margin:12px 0 0 0;padding-left:18px}
  .t-item:before{
    content:"";position:absolute;left:-2px;top:6px;width:10px;height:10px;border-radius:50%;
    background:linear-gradient(135deg, rgba(var(--accent),0.6), rgba(var(--accent),0.2));
    box-shadow:0 0 0 4px rgba(var(--accent),0.18)
  }
  .t-row{
    display:flex;gap:12px;align-items:center;justify-content:space-between;
    flex-wrap:wrap;padding:10px 12px;border-radius:12px;
    background:var(--overlay-light);border:1px solid var(--outline)
  }
  .t-date{color:var(--muted);font-size:13px}
  .t-summary{color:#fff;font-weight:700;font-size:14px}
  .t-actions{display:flex;gap:8px}

  .center{
    display:flex;align-items:center;gap:12px;
    min-height:30vh;padding:24px 18px;
    font-size:28px;color:var(--ink)
  }
  .loader{
    width:18px;height:18px;border-radius:50%;
    border:3px solid rgba(255,255,255,.25);
    border-top-color:rgba(var(--accent),0.8);
    animation:spin .9s linear infinite
  }
  @keyframes spin{to{transform:rotate(360deg)}}

  /* make "Retake quiz" / "Log out" / "View" smaller */
  .actions .btn,#history-list .t-actions .btn{
    font-size:.6em;padding:8px 12px;border-radius:12px
  }
</style>

<div class="wrap" id="dash-root">
  <div class="center"><span class="loader"></span> Preparing your luxury garage…</div>
</div>

<!-- Watchdog in case auth/network hangs -->
<script>
(function(){
  window.__boot_done=false;
  setTimeout(function(){
    if(window.__boot_done) return;
    const root=document.getElementById('dash-root');
    if(!root) return;
    root.innerHTML=`
      <div class="panel">
        <h2 style="margin:0 0 8px;font-family:'Syne',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">Something took too long</h2>
        <p class="sub">Auth or network issue. Try reloading, sign in here, or go back to the quiz.</p>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <a class="btn btn-ghost" href="/quiz">Go to Quiz</a>
          <button class="btn btn-primary" onclick="window.__inlineLogin && window.__inlineLogin()">Sign in with Google</button>
          <button class="btn btn-ghost" onclick="location.reload()">Reload</button>
        </div>
      </div>`;
  },8000);
})();
</script>

<!-- SOLID, NON-TRANSPARENT HISTORY MODAL -->
<div
  id="history-overlay"
  aria-hidden="true"
  style="
    position:fixed;
    inset:0;
    display:none;
    align-items:center;
    justify-content:center;
    padding:0 16px;
    z-index:2147483647;
    background:var(--overlay-dark);
    backdrop-filter:none;
    -webkit-backdrop-filter:none;
  "
>
  <div
    id="history-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="hist-ttl"
    style="
      position:relative;
      width:min(92vw,900px);
      max-height:85vh;
      overflow:auto;
      border-radius:18px;
      padding:24px 20px 20px;
      background:var(--bg-dark);
      border:1px solid var(--outline);
      box-shadow:0 30px 80px rgba(0,0,0,0.9);
      color:var(--ink);
      font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    "
  >
    <div
      style="
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap:10px;
        margin-bottom:12px;
      "
    >
      <h3
        id="hist-ttl"
        style="
          margin:0;
          font-family:'Syne',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          font-size:26px;
          line-height:1.2;
          color:var(--ink);
        "
      >Result details</h3>

      <button
        id="hist-close"
        aria-label="Close"
        style="
          width:36px;
          height:36px;
          border-radius:10px;
          display:grid;
          place-items:center;
          cursor:pointer;
          background:var(--overlay-light);
          border:1px solid var(--outline);
          color:var(--ink);
          font-size:16px;
          line-height:1;
        "
      >✕</button>
    </div>

    <div id="hist-body" style="color:rgba(255,255,255,.72); font-size:14px; line-height:1.5;"></div>
  </div>
</div>

<script>
(async function(){
  const root         = document.getElementById('dash-root');
  const overlay      = document.getElementById('history-overlay');
  const closeBtn     = document.getElementById('hist-close');
  const histBody     = document.getElementById('hist-body');

  // ========= inline login =========
  window.__inlineLogin = async function(){
    try{
      await sb.auth.signInWithOAuth({
        provider:'google',
        options:{ redirectTo: location.href }
      });
    }catch(e){ console.error(e); }
  };

  function fatal(msg){
    root.innerHTML=`
      <div class="panel">
        <h2 style="margin:0 0 8px;font-family:'Syne',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;">Something went wrong</h2>
        <p class="sub">${msg}</p>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-primary" onclick="window.__inlineLogin()">Sign in with Google</button>
          <a class="btn btn-ghost" href="/quiz">Go to Quiz</a>
          <button class="btn btn-ghost" onclick="location.reload()">Reload</button>
        </div>
      </div>`;
    window.__boot_done=true;
  }

  // ========= session bootstrap =========
  async function ensureSession(){
    // handle OAuth hash
    const hash=new URLSearchParams(location.hash.replace(/^#/,''));  
    const qs=new URLSearchParams(location.search);
    const at=hash.get('access_token')||qs.get('access_token');
    const rt=hash.get('refresh_token')||qs.get('refresh_token');
    if(at&&rt){
      try{ await sb.auth.setSession({access_token:at,refresh_token:rt}); }catch{}
      history.replaceState(null,'',location.pathname);
    }

    // try cached session
    try{
      const cached = sessionStorage.getItem('sbSession');
      if(cached){
        const s=JSON.parse(cached);
        if(s?.access_token && s?.refresh_token){
          await sb.auth.setSession({access_token:s.access_token,refresh_token:s.refresh_token});
        }
      }
    }catch{}

    // refresh
    try{ await sb.auth.refreshSession(); }catch{}
    const { data } = await sb.auth.getSession();
    if (data?.session) {
      sessionStorage.setItem('sbSession', JSON.stringify(data.session));
      sessionStorage.setItem('sbUserId', data.session.user?.id || '');
      sessionStorage.setItem('sbEmail',  data.session.user?.email || '');
    }
    return data?.session || null;
  }

  let session=null, user=null, token=null;
  try{ session=await ensureSession(); }catch(e){ console.error(e); }

  if(!session){
    root.innerHTML=`
      <div class="panel">
        <div class="brand">
          <div class="badge-luxe"></div>
          <div>
            <h1 class="ttl">Your Luxury Garage</h1>
            <p class="sub">Sign in to see your results.</p>
          </div>
        </div>
      </div>
      <div class="panel" style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn btn-primary" onclick="window.__inlineLogin()">Sign in with Google</button>
        <a class="btn btn-ghost" href="/quiz">Go to Quiz</a>
      </div>`;
    window.__boot_done=true;
    return;
  }

  token=session.access_token;
  user=session.user || {};
  const uid   = user.id    || sessionStorage.getItem('sbUserId') || '';
  const email = user.email || sessionStorage.getItem('sbEmail') || '';

  // ========= helpers =========
  function encodeAttr(val){
    return encodeURIComponent(String(val ?? ""));
  }
  function decodeAttr(val){
    try { return decodeURIComponent(String(val ?? "")); } catch { return String(val ?? ""); }
  }
  function svgCardImage(title, subtitle){
    const safeTitle = String(title || "Car").replace(/[^a-zA-Z0-9 _-]/g, "").slice(0, 28);
    const safeSub = String(subtitle || "").replace(/[^a-zA-Z0-9 _-]/g, "").slice(0, 36);
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="900" height="540" viewBox="0 0 900 540">
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#8ea5b6" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#04080c" stop-opacity="0.85"/>
          </linearGradient>
          <radialGradient id="g2" cx="0.2" cy="0.0" r="0.9">
            <stop offset="0%" stop-color="#8ea5b6" stop-opacity="0.35"/>
            <stop offset="70%" stop-color="#030608" stop-opacity="0.15"/>
            <stop offset="100%" stop-color="#030608" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <rect width="900" height="540" fill="url(#g1)"/>
        <rect width="900" height="540" fill="url(#g2)"/>
        <rect x="28" y="28" width="844" height="484" rx="22" ry="22" fill="#030608" fill-opacity="0.35" stroke="#ffffff" stroke-opacity="0.12"/>
        <text x="64" y="250" fill="#ffffff" fill-opacity="0.92" font-size="44" font-family="Montserrat, Arial, sans-serif" font-weight="700">${safeTitle}</text>
        <text x="64" y="300" fill="#ffffff" fill-opacity="0.65" font-size="22" font-family="Montserrat, Arial, sans-serif">${safeSub}</text>
      </svg>
    `;
    return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
  }
  function cardImagePlaceholder(c){
    return svgCardImage(c?.brand ?? "", c?.model ?? "");
  }
  function aiImageUrl(brand, model){
    const b = encodeURIComponent(String(brand || ""));
    const m = encodeURIComponent(String(model || ""));
    return `${CAR_IMAGE_URL}?brand=${b}&model=${m}`;
  }
  function scheduleAiRetry(imgEl, max=3){
    if (!imgEl) return;
    let attempt = 0;
    const aiSrc = imgEl.getAttribute("data-ai-src") || "";
    const fallback = imgEl.getAttribute("data-fallback") || "";
    const tick = () => {
      attempt += 1;
      if (attempt > max) return;
      const sep = aiSrc.includes("?") ? "&" : "?";
      imgEl.src = `${aiSrc}${sep}t=${Date.now()}`;
      setTimeout(tick, 4000 * attempt);
    };
    if (imgEl.src === fallback) {
      setTimeout(tick, 2500);
    }
  }
  function hydrateAiImages(scope){
    const root = scope || document;
    root.querySelectorAll('img[data-ai="1"]').forEach(img => {
      if (img.dataset.aiLoaded === "1") return;
      img.addEventListener("error", () => {
        const fb = img.getAttribute("data-fallback");
        if (fb && img.src !== fb) img.src = fb;
        scheduleAiRetry(img);
      }, { once: true });
      img.dataset.aiLoaded = "1";
    });
  }
  function shortSummary(r){
    const arr=Array.isArray(r.top3)?r.top3:[];
    return arr.slice(0,3)
      .map(c=>`${c.brand??''} ${c.model??''}`.trim())
      .filter(Boolean)
      .join(' • ')||'3 matches';
  }

  function renderTop3Cards(top3){
    if(!Array.isArray(top3) || !top3.length){
      return `<div class="panel">No results yet. <a href="/quiz" class="btn btn-primary" style="margin-left:6px;">Take the quiz</a></div>`;
    }
    return `
      <div class="grid" id="latest-grid">
        ${top3.slice(0,3).map((c,i)=>{
          const title=`${c.brand??''} ${c.model??''}`.trim();
          const img=aiImageUrl(c?.brand ?? "", c?.model ?? "");
          const fallback=cardImagePlaceholder(c);
          const reason=c.reason??'';
          return `
            <article class="card">
              <span class="badge">#${i+1}</span>
              <img class="card-img" src="${img}" alt="${title||'Car image'}" loading="lazy" data-ai="1" data-ai-src="${img}" data-brand="${encodeAttr(c?.brand ?? '')}" data-model="${encodeAttr(c?.model ?? '')}" data-fallback="${fallback}" onerror="this.onerror=null;this.src='${fallback}'">
              <div class="card-body">
                <h3>${title||'Car'}</h3>
                <p>${reason}</p>
              </div>
            </article>`;
        }).join('')}
      </div>`;
  }

  // ========= fetch history =========
  let limit=10, offset=0;

  async function fetchHistoryViaFn(extraOffset=0){
    const u = new URL(RESULTS_LIST_URL);
    u.searchParams.set('limit', String(limit));
    u.searchParams.set('offset', String(extraOffset));
    if (uid)   u.searchParams.set('uid', uid);
    if (email) u.searchParams.set('email', email);

    const res = await fetch(u.toString(), {
      headers: {
        Authorization: `Bearer ${token}`,
        "X-User-Id": uid,
        "X-User-Email": email
      },
      mode: "cors",
      credentials: "omit"
    });

    if (!res.ok) throw new Error(`resultsListCORS ${res.status}`);
    const json = await res.json();
    return json.items || [];
  }

  async function fetchHistoryViaSupabase(extraOffset=0){
    try{
      const { data, error } = await sb
        .from('results')
        .select('id, created_at, top3, answers')
        .eq('user_id', uid)
        .order('created_at', { ascending:false })
        .range(extraOffset, extraOffset + limit - 1);
      if (error) throw error;
      return Array.isArray(data) ? data : [];
    }catch(e){
      console.warn('Supabase fallback failed:', e.message);
      return [];
    }
  }

  async function fetchHistory(extraOffset=0){
    let items = [];
    try { items = await fetchHistoryViaFn(extraOffset); }
    catch (e) {
      console.warn('Function fetch failed, trying Supabase:', e.message);
    }
    if (!items.length) {
      try { items = await fetchHistoryViaSupabase(extraOffset); }
      catch (e) { console.warn('Supabase fetch also failed:', e.message); }
    }
    return items;
  }

  let items=[];
  try{ items=await fetchHistory(0); }
  catch(e){ console.error(e); }

  // ========= also pull local "fresh" picks from sessionStorage =========
  const localTop3    = JSON.parse(sessionStorage.getItem("carPicks")   || "null");
  const localAnswers = JSON.parse(sessionStorage.getItem("carAnswers")|| "null");

  let latest;
  if (Array.isArray(localTop3) && localTop3.length){
    latest = {
      id:         "local-latest",
      created_at: new Date().toISOString(),
      top3:       localTop3,
      answers:    localAnswers || {}
    };
    items = [latest, ...items];
  } else {
    latest = items[0] || null;
  }

  const moreExists = items.length > 1 && items.length >= limit;

  // ========= header =========
  root.innerHTML=`
    <div class="hero">
      <div class="brand">
        <div class="badge-luxe"></div>
        <div>
          <h1 class="ttl">Your Luxury Garage</h1>
          <p class="sub">${email ? `Signed in as ${email}` : ''}</p>
        </div>
      </div>
      <div class="actions">
        <a href="/quiz" class="btn btn-ghost">Retake quiz</a>
        <button id="logout" class="btn btn-primary">Log out</button>
      </div>
    </div>
  `;

  // ========= latest block =========
  const createdAt = latest?.created_at ? new Date(latest.created_at) : null;
  const latestTop3 = Array.isArray(latest?.top3) ? latest.top3 : [];

  const latestHtml = `
    <div class="section-ttl">
      <h2>Latest Matches ${createdAt?`<span class="sub">— ${createdAt.toLocaleDateString()}</span>`:''}</h2>
      <div></div>
    </div>
    ${renderTop3Cards(latestTop3)}
  `;

  // ========= history list (skip first item because it's "latest") =========
  function renderHistoryRows(list){
    return list.map(r=>{
      const dt=r.created_at?new Date(r.created_at):null;
      return `
        <div class="t-item">
          <div class="t-row">
            <div>
              <div class="t-date">${dt?dt.toLocaleString():''}</div>
              <div class="t-summary">${shortSummary(r)}</div>
            </div>
            <div class="t-actions">
              <button class="btn btn-ghost" data-view="${r.id}">View</button>
            </div>
          </div>
        </div>`;
    }).join('');
  }

  const historyWithoutLatest = items.slice(1);

  const historyHtml = `
    <div class="section-ttl" style="margin-top:24px;">
      <h2>History</h2>
      <div class="sub">Your previous quiz results</div>
    </div>
    <div class="panel timeline" id="history-list">
      ${
        historyWithoutLatest.length
          ? renderHistoryRows(historyWithoutLatest)
          : `<div class="t-item"><div class="t-row"><div class="t-summary">No past results yet.</div></div></div>`
      }
      ${moreExists?`<div style="margin-top:12px;"><button id="load-more" class="btn btn-ghost">Load more</button></div>`:''}
    </div>
  `;

  const container=document.createElement('div');
  container.innerHTML=latestHtml+historyHtml;
  root.appendChild(container);
  hydrateAiImages(root);
  window.__boot_done=true;

  // ========= load more =========
  document.getElementById('load-more')?.addEventListener('click',async()=>{
    const btn=document.getElementById('load-more');
    btn.disabled=true; btn.textContent='Loading…'; offset+=limit;
    try{
      const more=await fetchHistory(offset);
      const filteredMore = Array.isArray(more)
        ? more.filter(x=>x.id!=="local-latest")
        : [];

      if(!filteredMore.length){
        btn.textContent='No more results'; 
        return;
      }
      const beforeBtn=btn.parentNode;
      beforeBtn.insertAdjacentHTML('beforebegin', renderHistoryRows(filteredMore));

      if(filteredMore.length===limit){
        btn.disabled=false; btn.textContent='Load more';
      } else {
        btn.textContent='No more results';
      }

      items=items.concat(filteredMore);
    }catch(e){
      console.error(e);
      btn.textContent='Failed. Try again';
      btn.disabled=false;
    }
  });

  // ========= modal helpers (inline styles, no class .show) =========
  function openModal(innerHTML){
    histBody.innerHTML = innerHTML;
    overlay.style.display = 'flex';
    document.documentElement.classList.add('modal-open');
    document.body.classList.add('modal-open');
  }
  function closeModal(){
    overlay.style.display = 'none';
    histBody.innerHTML = '';
    document.documentElement.classList.remove('modal-open');
    document.body.classList.remove('modal-open');
  }

  closeBtn?.addEventListener('click',closeModal);
  overlay.addEventListener('click',e=>{
    if(e.target===overlay) closeModal();
  });
  document.addEventListener('keydown',e=>{
    if(e.key==='Escape' && overlay.style.display==='flex') closeModal();
  });

  // ========= view button (history detail popup) =========
  document.getElementById('history-list')?.addEventListener('click',e=>{
    const btn=e.target.closest('[data-view]');
    if(!btn) return;

    const id=btn.getAttribute('data-view');
    const rec=items.find(x=>String(x.id)===String(id));
    if(!rec) return;

    const picks   = Array.isArray(rec.top3)?rec.top3:[];
    const when    = rec.created_at?new Date(rec.created_at):null;
    const answers = rec.answers||{};

    // answers list
    const answersListHtml = `
      <ul style="margin:0;padding-left:18px;list-style:disc;color:rgba(255,255,255,.72);font-size:14px;">
        ${Object.entries(answers)
          .filter(([k])=>!k.startsWith('_') && k!=='_meta')
          .map(([key,val])=>{
            const label=key.replace(/[-_]/g,' ').replace(/\b\w/g,l=>l.toUpperCase());
            if(typeof val==='object'&&val!==null){
              const toggles=Object.entries(val)
                .filter(([_,v])=>v==='on')
                .map(([k])=>(
                  isNaN(k)
                    ? `<li style="margin-left:12px;">${k.replace(/[-_]/g,' ').replace(/\b\w/g,l=>l.toUpperCase())}</li>`
                    : `<li style="margin-left:12px;">${label}</li>`
                )).join('');
              return toggles
                ? `<li style="margin-bottom:6px;"><strong>${label}:</strong><ul>${toggles}</ul></li>`
                : '';
            }
            return `<li style="margin-bottom:6px;"><strong>${label}:</strong> ${val}</li>`;
          }).join('')}
      </ul>`;

    // car cards, inline opaque styles
    const carsHtml = picks.map((c,i)=>{
      const title  = `${c.brand??''} ${c.model??''}`.trim();
      const img    = aiImageUrl(c?.brand ?? "", c?.model ?? "");
      const fallback = cardImagePlaceholder(c);
      const reason = c.reason ?? '';

      return `
        <article
          style="
            position:relative;
            border-radius:18px;
            padding:16px 16px 14px;
            background:var(--overlay);
            border:1px solid var(--outline);
            box-shadow:0 20px 50px var(--overlay-dark);
            color:var(--ink);
            font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          "
        >
          <span
            style="
              position:absolute;
              top:12px;
              left:12px;
              z-index:2;
              padding:6px 10px;
              border-radius:999px;
              font-size:12px;
              font-weight:700;
              background:linear-gradient(135deg, rgba(var(--accent),0.6), rgba(var(--accent),0.2));
              color:var(--bg-darker);
              border:1px solid rgba(var(--accent),0.45);
              box-shadow:0 10px 26px var(--overlay);
            "
          >#${i+1}</span>

          <img class="card-img" data-ai="1" data-ai-src="${img}" data-brand="${encodeAttr(c?.brand ?? '')}" data-model="${encodeAttr(c?.model ?? '')}" data-fallback="${fallback}" src="${img}" alt="${title||'Car image'}" onerror="this.onerror=null;this.src='${fallback}'"
            style="
              width:100%;
              height:190px;
              object-fit:cover;
              display:block;
              background:var(--bg-darker);
              border-radius:12px;
              margin-bottom:12px;
            "/>

          <div>
            <h3
              style="
                margin:0 0 6px;
                font-family:'Syne',system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
                font-size:24px;
                font-weight:700;
                color:var(--ink);
                line-height:1.2;
              "
            >${title || 'Car'}</h3>

            <p
              style="
                margin:0;
                color:rgba(255,255,255,.72);
                font-size:14px;
                line-height:1.4;
              "
            >${reason}</p>
          </div>
        </article>
      `;
    }).join('');

    // final modal HTML body
    const detail = `
      <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">
        ${when ? when.toLocaleString() : ''}
      </div>

      <div
        style="
          display:grid;
          gap:16px;
          grid-template-columns:repeat(auto-fit,minmax(min(260px,100%),1fr));
          margin-bottom:20px;
        "
      >
        ${carsHtml}
      </div>

      <div
        style="
          background:var(--overlay-light);
          border:1px solid var(--outline);
          border-radius:16px;
          padding:16px;
          color:var(--ink);
          box-shadow:none;
          font-size:14px;
          line-height:1.4;
        "
      >
        <h4
          style="
            margin:0 0 12px;
            font-size:18px;
            font-weight:600;
            color:var(--ink);
            font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
          "
        >
          Your Quiz Answers
        </h4>
        ${answersListHtml}
      </div>
    `;

    openModal(detail);
    hydrateAiImages(histBody);
  });

  // ========= logout =========
  document.getElementById('logout')?.addEventListener('click',async()=>{
    try{ await sb.auth.signOut(); }finally{
      sessionStorage.removeItem("sbSession");
      sessionStorage.removeItem("sbUserId");
      sessionStorage.removeItem("sbEmail");
      sessionStorage.removeItem("carPicks");
      sessionStorage.removeItem("carAnswers");
      location.href='/quiz';
    }
  });

  // keep session fresh in storage
  sb.auth.onAuthStateChange((_event, sess)=>{
    if(sess){
      sessionStorage.setItem('sbSession', JSON.stringify(sess));
      sessionStorage.setItem('sbUserId', sess.user?.id || '');
      sessionStorage.setItem('sbEmail',  sess.user?.email || '');
    }
  });
})();
</script>
