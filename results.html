<!-- ========== RESULTS PAGE (FINAL) ========== -->

<!-- 1) Supabase bootstrap (must load before any auth logic) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.12.2/lottie.min.js"></script>
<script>
  // Your Supabase project keys
  const SUPABASE_URL  = "https://zrlfkdxpqkhfusjktrey.supabase.co";
  const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpybGZrZHhwcWtoZnVzamt0cmV5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTk4NDc1MzYsImV4cCI6MjA3NTQyMzUzNn0.FG3eMKO7KRJ_GM4XXo5DEIDlWU7j9tjMJRJwpotNd6Y";

  // Single shared Supabase client
  const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // expose globally so later scripts can use `sb`
  window.sb = sb;
</script>

<!-- 2) Results container -->
<div id="car-results-luxe"></div>

<script>
(() => {
  const host = document.getElementById("car-results-luxe");
  if (!host) return;
  const DEFAULT_SITE = "https://carbackendd.netlify.app";
  const FUNCTIONS_ORIGIN =
    (typeof window !== "undefined" && window.FUNCTIONS_ORIGIN)
      ? String(window.FUNCTIONS_ORIGIN).replace(/\/+$/, "")
      : DEFAULT_SITE;
  const NETLIFY_BASE = `${FUNCTIONS_ORIGIN}/.netlify/functions`;
  const CAR_IMAGE_URL = `${NETLIFY_BASE}/carImageCORS`;
  const AI_POLL_MS = 4000;
  const IMAGE_CACHE_KEY = "carImageCacheV1";
  const LOTTIE_ANIMATION_URL = "https://assets10.lottiefiles.com/packages/lf20_usmfx6bp.json";

  // restore quiz data from sessionStorage
  function safeJSON(str){ try { return JSON.parse(str || "null"); } catch { return null; } }
  const picks   = safeJSON(sessionStorage.getItem("carPicks"))   || [];
  const answers = safeJSON(sessionStorage.getItem("carAnswers")) || {};
  const imageCache = safeJSON(sessionStorage.getItem(IMAGE_CACHE_KEY))
    || safeJSON(localStorage.getItem(IMAGE_CACHE_KEY))
    || {};

  // helpers for rendering
  function esc(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }
  function initials(brand){
    const parts = String(brand).trim().split(/\s+/);
    if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
    return brand.slice(0,2).toUpperCase();
  }
  function encodeAttr(val){
    return encodeURIComponent(String(val ?? ""));
  }
  function decodeAttr(val){
    try { return decodeURIComponent(String(val ?? "")); } catch { return String(val ?? ""); }
  }
  function carKey(brand, model){
    return `${brand || ""}::${model || ""}`.toLowerCase().replace(/[^a-z0-9:]+/g, "");
  }
  function persistImageCache(){
    const raw = JSON.stringify(imageCache);
    try { sessionStorage.setItem(IMAGE_CACHE_KEY, raw); } catch (_) {}
    try { localStorage.setItem(IMAGE_CACHE_KEY, raw); } catch (_) {}
  }
  function rememberDisplayedImage(brand, model, url){
    const key = carKey(brand, model);
    if (!key || !url) return;
    imageCache[key] = url;
    persistImageCache();

    const stored = safeJSON(sessionStorage.getItem("carPicks")) || [];
    if (!Array.isArray(stored) || !stored.length) return;

    let changed = false;
    const next = stored.map((item) => {
      const k = carKey(item?.brand || "", item?.model || "");
      if (k !== key) return item;
      if (item?.image === url) return item;
      changed = true;
      return { ...(item || {}), image: url };
    });
    if (changed) {
      try { sessionStorage.setItem("carPicks", JSON.stringify(next)); } catch (_) {}
    }
  }
  function svgCardImage(title, subtitle){
    const safeTitle = String(title || "Car").replace(/[^a-zA-Z0-9 _-]/g, "").slice(0, 28);
    const safeSub = String(subtitle || "").replace(/[^a-zA-Z0-9 _-]/g, "").slice(0, 36);
    const svg = `
      <svg xmlns="http://www.w3.org/2000/svg" width="900" height="540" viewBox="0 0 900 540">
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#8ea5b6" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#04080c" stop-opacity="0.85"/>
          </linearGradient>
          <radialGradient id="g2" cx="0.2" cy="0.0" r="0.9">
            <stop offset="0%" stop-color="#8ea5b6" stop-opacity="0.35"/>
            <stop offset="70%" stop-color="#030608" stop-opacity="0.15"/>
            <stop offset="100%" stop-color="#030608" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <rect width="900" height="540" fill="url(#g1)"/>
        <rect width="900" height="540" fill="url(#g2)"/>
        <rect x="28" y="28" width="844" height="484" rx="22" ry="22" fill="#030608" fill-opacity="0.35" stroke="#ffffff" stroke-opacity="0.12"/>
        <text x="64" y="250" fill="#ffffff" fill-opacity="0.92" font-size="44" font-family="Montserrat, Arial, sans-serif" font-weight="700">${safeTitle}</text>
        <text x="64" y="300" fill="#ffffff" fill-opacity="0.65" font-size="22" font-family="Montserrat, Arial, sans-serif">${safeSub}</text>
      </svg>
    `;
    return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
  }
  function svgCardMarkup(title, subtitle){
    const safeTitle = String(title || "Car").replace(/[^a-zA-Z0-9 _-]/g, "").slice(0, 28);
    const safeSub = String(subtitle || "").replace(/[^a-zA-Z0-9 _-]/g, "").slice(0, 36);
    return `
      <svg xmlns="http://www.w3.org/2000/svg" width="900" height="540" viewBox="0 0 900 540">
        <defs>
          <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
            <stop offset="0%" stop-color="#8ea5b6" stop-opacity="0.35"/>
            <stop offset="100%" stop-color="#04080c" stop-opacity="0.85"/>
          </linearGradient>
          <radialGradient id="g2" cx="0.2" cy="0.0" r="0.9">
            <stop offset="0%" stop-color="#8ea5b6" stop-opacity="0.35"/>
            <stop offset="70%" stop-color="#030608" stop-opacity="0.15"/>
            <stop offset="100%" stop-color="#030608" stop-opacity="0"/>
          </radialGradient>
        </defs>
        <rect width="900" height="540" fill="url(#g1)"/>
        <rect width="900" height="540" fill="url(#g2)"/>
        <rect x="28" y="28" width="844" height="484" rx="22" ry="22" fill="#030608" fill-opacity="0.35" stroke="#ffffff" stroke-opacity="0.12"/>
        <text x="64" y="250" fill="#ffffff" fill-opacity="0.92" font-size="44" font-family="Montserrat, Arial, sans-serif" font-weight="700">${safeTitle}</text>
        <text x="64" y="300" fill="#ffffff" fill-opacity="0.65" font-size="22" font-family="Montserrat, Arial, sans-serif">${safeSub}</text>
      </svg>
    `;
  }
  function cardImagePlaceholder(brand, model){
    return svgCardImage(brand, model);
  }
  function aiImageStatusUrl(brand, model, trigger = false){
    const b = encodeURIComponent(String(brand || ""));
    const m = encodeURIComponent(String(model || ""));
    const t = trigger ? "&trigger=1" : "";
    return `${CAR_IMAGE_URL}?brand=${b}&model=${m}&mode=status${t}`;
  }
  function sleep(ms){
    return new Promise((resolve) => setTimeout(resolve, ms));
  }

  function preloadImage(url, timeout=8000){
    if (!url) return Promise.reject(new Error("no_url"));
    return new Promise((resolve, reject) => {
      const test = new Image();
      const done = (ok, err) => {
        clearTimeout(timer);
        test.onload = null;
        test.onerror = null;
        if (ok) resolve(url);
        else reject(err || new Error("load_failed"));
      };
      const timer = setTimeout(() => done(false, new Error("timeout")), timeout);
      test.onload = () => done(true);
      test.onerror = (e) => done(false, e);
      test.src = url;
    });
  }
  function setLoaderVisible(card, visible) {
    const loader = card?.querySelector("[data-ai-loader]");
    if (!loader) return;
    if (visible) {
      loader.classList.remove("is-hidden");
      loader.hidden = false;
    } else {
      loader.classList.add("is-hidden");
      loader.hidden = true;
      if (loader.__lottie) {
        loader.__lottie.destroy();
        loader.__lottie = null;
      }
    }
  }
  function setLoaderText(card, text) {
    const label = card?.querySelector("[data-ai-loader-text]");
    if (label) label.textContent = String(text || "");
  }
  function startLoaderAnimation(card) {
    const loader = card?.querySelector("[data-ai-loader]");
    const mount = card?.querySelector("[data-ai-lottie]");
    if (!loader || !mount || !window.lottie || loader.__lottie) return;
    loader.__lottie = window.lottie.loadAnimation({
      container: mount,
      renderer: "svg",
      loop: true,
      autoplay: true,
      path: LOTTIE_ANIMATION_URL
    });
  }
  async function pollCardForAiImage(imgEl){
    if (!imgEl || imgEl.dataset.aiPolling === "1") return;
    imgEl.dataset.aiPolling = "1";

    const card = imgEl.closest(".card");
    const brand = decodeAttr(imgEl.getAttribute("data-brand") || "");
    const model = decodeAttr(imgEl.getAttribute("data-model") || "");
    let firstPoll = true;

    setLoaderVisible(card, true);
    setLoaderText(card, "Generating AI image...");
    startLoaderAnimation(card);

    while (true) {
      if (!imgEl.isConnected) return;
      try {
        const statusRes = await fetch(aiImageStatusUrl(brand, model, firstPoll), {
          method: "GET",
          mode: "cors",
          credentials: "omit",
          cache: "no-store"
        });
        firstPoll = false;

        const payload = await statusRes.json().catch(() => null);
        if (statusRes.ok && payload?.status === "ready" && payload?.url) {
          await preloadImage(payload.url, 12000);
          imgEl.src = payload.url;
          rememberDisplayedImage(brand, model, payload.url);
          setLoaderVisible(card, false);
          return;
        }
        if (payload?.status === "error") {
          setLoaderText(card, "AI image delayed, retrying...");
          setLoaderVisible(card, true);
        }
      } catch (_) {}

      await sleep(AI_POLL_MS);
      if (!imgEl.isConnected) return;
      startLoaderAnimation(card);
    }
  }

  // shadow root for the fancy layout
  const shadow = host.attachShadow({ mode: "open" });
  const html = String.raw;

  const tpl = document.createElement("template");
  tpl.innerHTML = html`
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Syne:wght@500;600;700&family=Montserrat:wght@400;500;600&display=swap');

      :host { all: initial; }
      .root{
        --bg:#060a0e; --bg-2:#030608; --text:rgba(255,255,255,.94); --muted:rgba(255,255,255,.68);
        --outline:rgba(255,255,255,.1); --surface:rgba(142,165,182,.05);
        --overlay-light:rgba(4,8,12,.3); --overlay:rgba(4,8,12,.5); --overlay-dark:rgba(4,8,12,.6);
        --accent:142,165,182;
        --shadow:0 10px 30px rgba(4,8,12,.45), inset 0 1px 0 rgba(255,255,255,.04);
        --radius:18px;
        font-family:"Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        color:var(--text);
        background:var(--bg);
        position:relative; isolation:isolate;
        padding:min(7vh,56px) 20px 80px;
      }
      .root::before{
        content:""; position:absolute; inset:0;
        background:
          radial-gradient(900px 600px at 15% -10%, rgba(var(--accent),.18), transparent 60%),
          radial-gradient(1000px 700px at 85% -10%, rgba(var(--accent),.08), transparent 55%),
          linear-gradient(180deg, var(--bg-2) 0%, var(--bg) 100%);
        z-index:-1;
      }
      .wrap{ max-width:1200px; margin:0 auto; }
      .kicker{
        letter-spacing:.22em; text-transform:uppercase; color:rgba(var(--accent),.85);
        font-size:12px; font-weight:600; opacity:.9;
      }
      .title{
        font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; font-weight:700; line-height:1.12;
        font-size:clamp(28px,4.2vw,46px); margin:.15em 0 .35em;
        background:linear-gradient(180deg, rgba(255,255,255,.98) 0%, rgba(255,255,255,.82) 60%, rgba(255,255,255,.68) 100%);
        -webkit-background-clip:text; background-clip:text; color:transparent;
      }
      .sub{
        color:var(--muted); max-width:70ch; font-size:15.5px; margin:0 0 18px;
      }

      .actions{
        display:flex; gap:10px; flex-wrap:wrap; margin:6px 0 22px;
      }
      .btn{
        position:relative; appearance:none; border:0; border-radius:999px;
        padding:10px 14px;
        font-weight:600; font-size:13px; letter-spacing:.02em; color:var(--text);
        background:rgba(255,255,255,.06);
        border:1px solid var(--outline);
        transition: filter .25s ease, transform .2s ease, box-shadow .2s ease;
        outline:none; overflow:hidden; cursor:pointer; text-decoration:none;
      }
      .btn::before{
        content:""; position:absolute; inset:0; border-radius:inherit; padding:1px;
        background:linear-gradient(90deg, rgba(var(--accent),.55), rgba(var(--accent),.15));
        -webkit-mask:linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0);
        -webkit-mask-composite:xor; mask-composite:exclude;
        pointer-events:none;
      }
      .btn:hover{
        transform:translateY(-1px); filter:brightness(1.06);
      }
      .btn.primary{
        background:linear-gradient(135deg, rgba(var(--accent),.45), rgba(var(--accent),.15));
        border:1px solid rgba(var(--accent),.45);
        color:var(--text);
      }

      .grid{
        display:grid; gap:18px; grid-template-columns:1fr;
      }
      @media (min-width:880px){
        .grid{ grid-template-columns:repeat(3,1fr); }
      }

      .card{
        position:relative; border-radius:var(--radius); padding:22px 20px 18px;
        background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), var(--surface);
        border:1px solid var(--outline);
        box-shadow:var(--shadow);
        overflow:hidden;
      }
      .card::before{ z-index:0; }
      .card > *{ position:relative; z-index:1; }
      .card-media{
        margin:-22px -20px 14px;
        border-bottom:1px solid var(--outline);
        background:var(--bg-2);
        position:relative;
        height:190px;
        overflow:hidden;
      }
      .card-fallback{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
      }
      .card-fallback svg{
        width:100%;
        height:100%;
        display:block;
      }
      .card-img{
        position:absolute;
        inset:0;
        width:100%;
        height:100%;
        display:block;
        object-fit:cover;
        z-index:1;
      }
      .ai-loader{
        position:absolute;
        inset:0;
        z-index:2;
        display:flex;
        flex-direction:column;
        align-items:center;
        justify-content:center;
        gap:10px;
        background:linear-gradient(180deg, rgba(3,6,8,.72), rgba(3,6,8,.86));
        transition:opacity .25s ease;
      }
      .ai-loader.is-hidden{
        opacity:0;
        pointer-events:none;
      }
      .ai-loader-lottie{
        width:72px;
        height:72px;
      }
      .ai-loader-text{
        font-size:12px;
        letter-spacing:.06em;
        text-transform:uppercase;
        color:rgba(255,255,255,.78);
      }
      .rank{
        font-size:12px; color:rgba(var(--accent),.85); letter-spacing:.16em;
        text-transform:uppercase; margin-bottom:6px;
      }
      .name{ display:flex; align-items:center; gap:10px; }
      .badge{
        width:34px;height:34px;border-radius:50%;
        background:
          radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), rgba(255,255,255,.1) 40%, transparent 60%),
          linear-gradient(135deg, rgba(var(--accent),.6), rgba(var(--accent),.2));
        border:1px solid rgba(var(--accent),.45);
        display:grid; place-items:center;
        color:var(--bg-2); font-weight:700; font-size:12px;
      }
      .name h2{
        margin:0;
        font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        font-size:22px;
        line-height:1.15;
        letter-spacing:.2px;
        color:var(--text);
      }
      .reason{
        color:var(--muted); margin:10px 0 16px; font-size:14.5px;
      }

      .summary{
        margin-top:28px; padding:18px; border-radius:calc(var(--radius)+2px);
        background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)), var(--surface);
        border:1px solid var(--outline); box-shadow:var(--shadow);
      }
      .summary h3{
        margin:0 0 10px;
        font-family:"Syne",system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        font-size:18px;
        background:linear-gradient(180deg, rgba(255,255,255,.98), rgba(255,255,255,.75));
        -webkit-background-clip:text;
        background-clip:text;
        color:transparent;
      }
      .dl{
        display:grid;
        grid-template-columns:180px 1fr;
        gap:8px 16px;
        margin:0;
      }
      .dl dt{ color:var(--muted); }
      .dl dd{ margin:0; color:var(--text); }
      @media (max-width:640px){
        .dl{ grid-template-columns:1fr; }
      }
    </style>

    <section class="root">
      <div class="wrap">
        <div class="kicker">Curated for you</div>
        <h1 class="title">Your Top Car Matches</h1>
        <p class="sub">Hand-picked based on your preferences. Refined, reliable, and ready to turn heads.</p>

        <div class="actions">
          <button id="saveBtn" class="btn primary">Save my results</button>
          <a class="btn" href="/quiz-page-en">Retake quiz</a>
        </div>

        <div id="grid" class="grid" role="list"></div>

        <div id="summary" class="summary" hidden>
          <h3>Your selections</h3>
          <dl class="dl" id="dl"></dl>
        </div>
      </div>
    </section>
  `;
  shadow.appendChild(tpl.content.cloneNode(true));

  // render car cards
  const grid = shadow.getElementById("grid");
  if (Array.isArray(picks) && picks.length) {
    grid.innerHTML = picks.slice(0,3).map((p, i) => {
      const brandRaw = p.brand || "Brand";
      const modelRaw = p.model || "";
      const brand  = esc(brandRaw);
      const model  = esc(modelRaw);
      const reason = esc(p.reason || "");
      const badge  = initials(brandRaw);
      const fallbackUrl = cardImagePlaceholder(brandRaw, modelRaw);
      return `
        <article class="card" role="listitem" aria-label="${brand} ${model}" data-brand="${encodeAttr(brandRaw)}" data-model="${encodeAttr(modelRaw)}">
          <div class="card-media">
            <div class="card-fallback" aria-hidden="true">${svgCardMarkup(brandRaw, modelRaw)}</div>
            <img class="card-img" src="${fallbackUrl}" alt="${brand} ${model}" loading="lazy" data-ai="1" data-brand="${encodeAttr(brandRaw)}" data-model="${encodeAttr(modelRaw)}">
            <div class="ai-loader" data-ai-loader role="status" aria-live="polite">
              <div class="ai-loader-lottie" data-ai-lottie></div>
              <div class="ai-loader-text" data-ai-loader-text>Generating AI image...</div>
            </div>
          </div>
          <div class="rank">#${i+1} match</div>
          <div class="name">
            <div class="badge" aria-hidden="true">${badge}</div>
            <h2>${brand} ${model}</h2>
          </div>
          <p class="reason">${reason}</p>
        </article>
      `;
    }).join("");
  } else {
    grid.innerHTML = `
      <article class="card" role="listitem" style="grid-column: 1/-1; text-align:center; padding:32px;">
        <div class="card-media">
          <div class="card-fallback" aria-hidden="true">${svgCardMarkup("No results", "Take the quiz")}</div>
          <img class="card-img" src="${svgCardImage("No results", "Take the quiz")}" alt="No results">
        </div>
        <h2>No results</h2>
        <p class="reason">Please return to the quiz and try again.</p>
        <div><a class="btn" href="/quiz-page-en">Retake Quiz</a></div>
      </article>
    `;
  }
  // hydrate AI images for results
  grid.querySelectorAll('img[data-ai="1"]').forEach(img => {
    pollCardForAiImage(img);
  });

  // summary (answers list)
  const LABELS = {
    q1_bodyType:     "Preferred body type",
    q2_budget:       "Budget",
    q3_fuel:         "Fuel type",
    q4_usage:        "Primary use",
    q5_range:        "Range need",
    q6_features:     "Must-have features",
    q7_chargeTime:   "Charging patience",
    q8_dailyDistance:"Daily distance",
    q9_brands:       "Brand preferences",
    q10_color:       "Color preference",
  };

  let entries = [];
  if (Array.isArray(answers)) {
    entries = answers.map((item) => [item?.question || "", item?.answer || ""]);
  } else {
    entries = Object.entries(answers || {}).filter(([k]) => k !== "_meta");
  }

  if (entries.length) {
    const dl = shadow.getElementById("dl");
    dl.innerHTML = entries.map(([k, v]) => {
      const label = esc(LABELS[k] || k);
      const val   = Array.isArray(v) ? v.join(", ") : String(v);
      return `<dt>${label}</dt><dd>${esc(val)}</dd>`;
    }).join("");
    shadow.getElementById("summary").hidden = false;
  }

  // "Save my results" button opens auth modal
  shadow.getElementById("saveBtn")?.addEventListener("click", () => {
    openAuthModal('signup');
  });

})();
</script>

<!-- 3) Auth modal (lives in main DOM so it can overlay the entire page) -->
<style>
  :root{
    --brand-bg:#060a0e;
    --brand-bg-2:#030608;
    --brand-ink:rgba(255,255,255,.94);
    --brand-muted:rgba(255,255,255,.68);
    --brand-outline:rgba(255,255,255,.1);
    --brand-surface:rgba(142,165,182,.05);
    --brand-overlay-light:rgba(4,8,12,.3);
    --brand-overlay:rgba(4,8,12,.5);
    --brand-overlay-dark:rgba(4,8,12,.6);
    --brand-accent:142,165,182;
  }
  #auth-overlay, #auth-overlay * { box-sizing: border-box; }
  .auth-overlay{
    position:fixed; inset:0;
    display:none;
    align-items:center; justify-content:center;
    background: var(--brand-overlay-dark);
    backdrop-filter: blur(12px) saturate(120%);
    -webkit-backdrop-filter: blur(12px) saturate(120%);
    z-index: 2147483647;
  }
  .auth-overlay.is-open{ display:flex; }
  .auth-card{
    width:min(92vw, 520px);
    border-radius:18px;
    padding:22px 22px 20px;
    background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02)), var(--brand-bg);
    border:1px solid var(--brand-outline);
    color:var(--brand-ink);
    box-shadow: 0 30px 80px var(--brand-overlay-dark), inset 0 1px 0 rgba(255,255,255,0.06);
    font-family: "Montserrat", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    max-height:min(85vh,760px);
    overflow:auto;
  }
  .auth-card h3{
    margin:0 0 6px;
    font-family:"Syne", system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    font-weight:600;
    font-size:26px;
    letter-spacing:.2px;
    color:var(--brand-ink);
  }
  .auth-sub{
    margin:0 0 16px;
    font-size:13px;
    color:var(--brand-muted);
  }
  .auth-form{ display:grid; gap:12px; }
  .auth-row{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:12px;
  }
  @media (max-width:560px){
    .auth-row{ grid-template-columns:1fr; }
  }
  .auth-label{
    display:block;
    margin:0 0 6px;
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:.08em;
    color:var(--brand-muted);
  }
  .auth-input, .auth-select{
    width:100%;
    height:44px;
    padding:10px 12px;
    border-radius:12px;
    background:var(--brand-overlay-light);
    color:var(--brand-ink);
    border:1px solid var(--brand-outline);
    outline:none;
    box-shadow:none;
    -webkit-appearance:none;
    appearance:none;
    font-size:14px;
  }
  .auth-select{
    cursor:pointer;
    padding-right:40px;
    background-image:
      linear-gradient(45deg, transparent 50%, rgba(255,255,255,.85) 50%),
      linear-gradient(135deg, rgba(255,255,255,.85) 50%, transparent 50%);
    background-position:
      calc(100% - 20px) 18px,
      calc(100% - 14px) 18px;
    background-size:6px 6px, 6px 6px;
    background-repeat:no-repeat;
  }
  .auth-select:invalid{
    color:var(--brand-muted);
  }
  .auth-select option{
    background:#0b1016;
    color:#f5f7fa;
  }
  .auth-select option[value=""]{
    color:#9aa5b4;
  }
  .auth-input:hover, .auth-select:hover{
    border-color: rgba(var(--brand-accent),0.35);
  }
  .auth-input:focus, .auth-select:focus{
    border-color: rgba(var(--brand-accent),0.6);
    box-shadow:0 0 0 3px rgba(var(--brand-accent),0.25);
  }
  .auth-btn{
    height:48px;
    margin-top:6px;
    border-radius:14px;
    font-weight:700;
    letter-spacing:.02em;
    background: linear-gradient(135deg, rgba(var(--brand-accent),.45), rgba(var(--brand-accent),.15));
    border:1px solid rgba(var(--brand-accent),.45);
    color:var(--brand-ink);
    box-shadow:0 12px 36px var(--brand-overlay);
    font-size:70%;
    line-height:1.1;
  }

  .auth-close{
    position:absolute;
    top:10px; right:10px;
    width:34px; height:34px;
    border-radius:50%;
    display:grid; place-items:center;
    color:var(--brand-ink);
    background: var(--brand-overlay-light);
    border:1px solid var(--brand-outline);
    cursor:pointer;
  }

  /* login mode hides profile fields + changes button color */
  #auth-overlay.login .auth-extra{
    display:none !important;
  }
  #auth-overlay.login #auth-submit{
    background: linear-gradient(135deg, rgba(4,8,12,.6), rgba(4,8,12,.3));
    color:var(--brand-ink);
    box-shadow:none;
  }
</style>

<div id="auth-overlay" class="auth-overlay" aria-hidden="true">
  <div class="auth-card" role="dialog" aria-modal="true" aria-labelledby="auth-title">
    <button type="button" class="auth-close" id="auth-close" aria-label="Close">✕</button>

    <h3 id="auth-title">Create account to save your matches</h3>
    <p id="auth-sub" class="auth-sub">We’ll save your results to your dashboard.</p>

    <form id="auth-form" class="auth-form" autocomplete="on">
      <div>
        <label class="auth-label" for="auth_email">Email</label>
        <input class="auth-input" type="email" id="auth_email" placeholder="you@email.com" required>
      </div>

      <div>
        <label class="auth-label" for="auth_password">Password</label>
        <input class="auth-input" type="password" id="auth_password" placeholder="••••••••" required>
      </div>

      <div class="auth-extra">
        <div>
          <label class="auth-label" for="auth_name">Full name</label>
          <input class="auth-input" type="text" id="auth_name" placeholder="John Smith" required>
        </div>
        <div>
          <label class="auth-label" for="auth_nickname">First name / Nickname</label>
          <input class="auth-input" type="text" id="auth_nickname" placeholder="John" required>
        </div>

        <div class="auth-row">
          <div>
            <label class="auth-label" for="auth_dob">Date of birth</label>
            <input class="auth-input" type="date" id="auth_dob" required>
          </div>
          <div>
            <label class="auth-label" for="auth_gender">Gender</label>
            <select class="auth-select" id="auth_gender" required>
              <option value="">Select…</option>
              <option>Female</option>
              <option>Male</option>
              <option>Non-binary</option>
              <option>Prefer not to say</option>
            </select>
          </div>
        </div>

        <div class="auth-row">
          <div>
            <label class="auth-label" for="auth_country">Country</label>
            <input class="auth-input" type="text" id="auth_country" placeholder="United States" required>
          </div>
          <div>
            <label class="auth-label" for="auth_state">State/Region</label>
            <input class="auth-input" type="text" id="auth_state" placeholder="California">
          </div>
        </div>
      </div>

      <button type="submit" id="auth-submit" class="auth-btn">Create account</button>

      <div style="margin-top:6px; font-size:12px;">
        <a href="#" id="auth-forgot" style="color:#e7e9ee; text-decoration:underline; display:none;">Forgot password?</a>
      </div>

      <div id="auth-msg" style="margin-top:8px; font-size:12px; color:#c7c9d1; min-height:16px;"></div>
    </form>
  </div>
</div>

<script>
/* ---------- modal open/close + mode switch ---------- */
function setAuthMode(mode) {
  const overlay = document.getElementById('auth-overlay');
  const title   = document.getElementById('auth-title');
  const sub     = document.getElementById('auth-sub');
  const btn     = document.getElementById('auth-submit');
  const forgot  = document.getElementById('auth-forgot');

  overlay.classList.remove('login','signup');
  overlay.classList.add(mode === 'login' ? 'login' : 'signup');

  if (mode === 'login') {
    title.textContent = "Log in to save your matches";
    sub.textContent   = "Welcome back — enter your password to continue.";
    btn.textContent   = "Log in";
    forgot.style.display = 'inline';
  } else {
    title.textContent = "Create account to save your matches";
    sub.textContent   = "We’ll save your results to your dashboard.";
    btn.textContent   = "Create account";
    forgot.style.display = 'none';
  }
  document.getElementById('auth-msg').textContent = "";
}

function openAuthModal(defaultMode='signup'){
  setAuthMode(defaultMode);
  const overlay = document.getElementById('auth-overlay');
  overlay.classList.add('is-open');
  overlay.setAttribute('aria-hidden', 'false');
}

function closeAuthModal(){
  const overlay = document.getElementById('auth-overlay');
  overlay.classList.remove('is-open');
  overlay.setAttribute('aria-hidden','true');
}

document.getElementById('auth-close')?.addEventListener('click', closeAuthModal);
document.addEventListener('keydown', (e)=>{
  if (e.key==='Escape' && document.getElementById('auth-overlay')?.classList.contains('is-open')) {
    closeAuthModal();
  }
});
document.getElementById('auth-overlay')?.addEventListener('click', (e)=>{
  if(e.target===e.currentTarget) closeAuthModal();
});

/* ---------- helpers for API ---------- */
async function postJson(url, payload, token) {
  const res = await fetch(url, {
    method: "POST",
    headers: {
      "Content-Type":"application/json",
      ...(token ? { "Authorization": `Bearer ${token}` } : {})
    },
    body: JSON.stringify(payload),
    mode:"cors",
    credentials:"omit"
  });

  const text = await res.text();
  let data;
  try { data = text ? JSON.parse(text) : null; } catch { data = text; }

  if (!res.ok) {
    throw new Error(typeof data === "string" ? data : JSON.stringify(data));
  }
  return data;
}

/* ---------- signup / login / save ---------- */
async function handleAuthAndSave(profile, answers, top3) {
  const {
    email,
    password,
    name,
    nickname,
    dob,
    gender,
    country,
    state
  } = profile;

  const msg     = document.getElementById('auth-msg');
  const btn     = document.getElementById('auth-submit');
  const overlay = document.getElementById('auth-overlay');
  const mode    = overlay.classList.contains('login') ? 'login' : 'signup';

  const setMsg = (t) => { msg.textContent = t; };

  try {
    btn.disabled = true;

    // 1. Auth step
    if (mode === 'login') {
      setMsg("Signing you in…");
      const { error } = await sb.auth.signInWithPassword({ email, password });
      if (error) {
        const m = (error.message || '').toLowerCase();
        if (m.includes('invalid') || m.includes('password')) {
          setMsg("Incorrect password. Try again or reset it.");
          document.getElementById('auth-forgot').style.display = 'inline';
          btn.disabled = false;
          return;
        }
        if (m.includes('email not confirmed')) {
          setMsg("Please confirm your email, then log in.");
          btn.disabled = false;
          return;
        }
        throw error;
      }
    } else {
      setMsg("Creating your account…");
      const { error } = await sb.auth.signUp({ email, password });
      if (error) {
        const m = (error.message || '').toLowerCase();
        if (m.includes('already') || m.includes('exists')) {
          // Switch to login mode if the email is already in use
          setAuthMode('login');
          setMsg("This email is already registered. Please log in.");
          document.getElementById('auth-forgot').style.display = 'inline';
          btn.disabled = false;
          return;
        }
        throw error;
      }

      // If email confirmation is required, user might not be "logged in" yet
      const afterSignup = await sb.auth.getSession();
      const tokenAfter  = afterSignup?.data?.session?.access_token;
      if (!tokenAfter) {
        setMsg("Check your email to confirm your account, then log in.");
        btn.disabled = false;
        return;
      }
    }

    // 2. get session/access token
    const sess  = await sb.auth.getSession();
    const token = sess?.data?.session?.access_token;
    if (!token) {
      setMsg("No session. Please log in again.");
      btn.disabled = false;
      return;
    }

    // 3. Save EVERYTHING in one request to profileUpsertCORS
    //    This creates/updates the profile AND stores the quiz result in `results`
    setMsg("Saving your data…");
    await postJson(
      `${NETLIFY_BASE}/profileUpsertCORS`,
      {
        email,
        name,
        nickname,
        dob,
        gender,
        country,
        state,
        answers, // quiz answers
        top3     // top 3 cars
      },
      token
    );

    // 4. success -> dashboard
    setMsg("Saved! You can now visit your dashboard.");
    setTimeout(()=>{
      closeAuthModal();
      window.location.href = "/dashboard";
    }, 800);

  } catch (e) {
    console.error(e);
    const raw = e?.message || String(e);
    msg.textContent = /failed to fetch/i.test(raw)
      ? "Network error. Please check your connection and try again."
      : raw;
    btn.disabled = false;
  }
}

/* ---------- bind modal form submit ---------- */
document.getElementById('auth-form')?.addEventListener('submit', async (e)=>{
  e.preventDefault();

  const answers = JSON.parse(sessionStorage.getItem("carAnswers") || "null");
  const top3    = JSON.parse(sessionStorage.getItem("carPicks")   || "null");

  if (!answers || !top3) {
    document.getElementById('auth-msg').textContent =
      "No results to save. Retake the quiz.";
    return;
  }

  const profile = {
    email:     document.getElementById('auth_email')?.value.trim(),
    password:  document.getElementById('auth_password')?.value,
    name:      document.getElementById('auth_name')?.value?.trim(),
    nickname:  document.getElementById('auth_nickname')?.value?.trim(),
    dob:       document.getElementById('auth_dob')?.value,
    gender:    document.getElementById('auth_gender')?.value,
    country:   document.getElementById('auth_country')?.value?.trim(),
    state:     document.getElementById('auth_state')?.value?.trim()
  };

  await handleAuthAndSave(profile, answers, top3);
});

/* ---------- forgot password ---------- */
document.getElementById('auth-forgot')?.addEventListener('click', async (e)=>{
  e.preventDefault();
  const email = document.getElementById('auth_email')?.value.trim();
  const msg   = document.getElementById('auth-msg');
  if (!email) {
    msg.textContent = "Enter your email first.";
    return;
  }
  try {
    msg.textContent = "Sending reset link…";
    const { error } = await sb.auth.resetPasswordForEmail(email, {
      redirectTo: location.origin + "/reset-done"
    });
    if (error) throw error;
    msg.textContent = "Reset link sent. Check your email.";
  } catch (err) {
    console.error(err);
    msg.textContent = (err.message || "Could not send reset link.");
  }
});
</script>
